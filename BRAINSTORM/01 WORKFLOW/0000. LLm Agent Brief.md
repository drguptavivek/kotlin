here’s a compact, “agent-brief” that captures the intent, flows, APIs, and constraints for SurveyLauncher. It’s written so another LLM agent (or a coding agent swarm) can pick it up and work without re-reading the whole spec.

# SurveyLauncher — LLM Agent Brief

## 1) Mission & scope (what we’re building)

* **Android launcher (Device Owner / kiosk)** that enforces: app allow-list (ODK, Browser, Custom), team login windows, server-anchored time, radios/background-data controls, PIN unlock (team + supervisor), offline grace, and structured telemetry. 
* **Flask backend** that authenticates devices, signs & serves **team policies**, manages **versioned PINs** (server-generated; plaintext reveal only for admins), ingests telemetry, and exposes admin/supervisor dashboards. 

## 2) Core roles & data model (who/what exists)

* Roles: **national admin** (global), **state admin** (per-state), **team member**, **supervisor** (team-scoped). Entities: **STATE, TEAM, USER, ROLE, USER_ROLE, SUPERVISOR, DEVICE, PIN** (PIN scoped **only to team_id**, versioned). 

## 3) Provisioning (how devices join)

Two distinct QR phases; **no pre-enrolled devices**:

1. **Phase A (OS provisioning):** Android Setup QR installs APK and sets **Device Owner** (first-boot flow). Reusable across all teams. 
2. **Phase B (App enrollment):** Team **Enrollment QR** (short-TTL JWT) → app calls **`POST /v1/provision`** with device facts (android_id, model, OS, DO status…). Server **upserts DEVICE**, returns **device_access_token**. 

Device runtime loop afterwards: **heartbeat**, **policy pull**, **events**, **admin block/unblock** respected by launcher. 

## 4) Policy & time (how rules apply)

* Device pulls a **signed team policy** (Ed25519) containing app allow-list, **login/launch windows**, min versions, offline grace, and **PIN verifiers (TP/SP) with versions**; device **never** receives plaintext PINs. All gate decisions use **server-anchored time** (trusted clock). 

## 5) PIN model & flows (unlock logic)

* Server **generates** Team PIN (TP) and Supervisor PIN (SP); DB stores **Argon2id verifier** + **AEAD-encrypted plaintext** to allow **admin reveal** when needed. Devices get only verifiers+params in policy. 
* **Supervisor session**: first valid SP use starts a **12-hour** session; after expiry, local TP becomes invalid until device fetches fresh policy (prevents stale TP misuse). 

## 6) Device APIs (what the launcher calls)

* **`POST /v1/provision`** → issue device token; create/update DEVICE (idempotent by android_id).
* **`POST /v1/heartbeat`** → liveness + server_epoch_ms + skew hints; server can signal BLOCKED/RETIRED.
* **`GET /v1/policy`** → signed policy blob with TP/SP **verifiers** (+ versions, session secs, time anchor).
* **`POST /v1/policy/ack`** → audit that policy was applied.
* **`POST /v1/pin/verify`** (optional) → online confirm + drift resolution.
* **`POST /v1/events/batch`** → telemetry (pin_success/failure, ss_started/expired, time_violation…).
* *(Optional)* **`POST /v1/supervisor/redeem`** for OTP/QR-grant flow (if enabled).  

## 7) Admin APIs (what the console/back-office uses)

* **Devices**: list/search/get, block/unblock/retire/transfer, export CSV. 
* **PINs**: generate TP/SP (server-random), **reveal plaintext** (support use), revoke versions, list current/history. Devices update on next policy pull; plaintext is **never** sent to devices. 
* **Teams**: issue **Enrollment QR tokens** (JWT + QR SVG) for Phase B. 

## 8) Launcher enforcement (what to implement on Android)

* **Device Owner / kiosk**: persistent HOME, lock task, disable status bar (API-gated), user restrictions, hide/suspend non-whitelisted apps.
* **Radios & data**: disable BT/NFC/tethering/USB as available; Data Saver ON; background allow-list only for Launcher + ODK; Location ON (grant to ODK).
* **Trusted clock**: maintain `trusted_now()` from `server_epoch_ms` + `elapsedRealtime()`; block if skew beyond thresholds; permit within offline grace.
* **Grey tiles & messaging** for outside window / outdated versions; structured local events with batch upload. 

## 9) Telemetry & audits (what gets logged)

Event types (minimal): `login_success/denied`, `app_launch/denied`, `pin_success/failure (TP|SP)`, `ss_started/expired`, `tp_invalidated_by_ss_expiry`, `policy_applied`, `time_violation_detected`. Batched uploads, size-capped, schema-validated server-side. 

## 10) Success criteria (how we measure done)

* ≥95% devices operational daily; ≥90% logins **within windows**; time-skew violations <2% after week 2; background data reduced ≥60%; policy propagation ≤10 min TTL; Forgot-PIN/server-PIN flows complete ≤5 min online. 

---

## Quick “interfaces at a glance”

### Device → Server

* **Provision**: `POST /v1/provision` → `{ device_access_token }` (JWT)
* **Policy**: `GET /v1/policy?device_id=...` → `{ policy_id, server_epoch_ms, tp{verifier,params,version}, sp{...}, signature }`
* **Heartbeat**: `POST /v1/heartbeat` → `{ server_epoch_ms, time_skew_ms }`
* **Events**: `POST /v1/events/batch` → `{ accepted }`
* **(Opt) PIN verify**: `POST /v1/pin/verify` → `{ ok, tp_version, sp_version, policy_id }` 

### Admin Console → Server

* **Devices**: list/get/block/unblock/retire/transfer/export. 
* **PINs**: `team/supervisor/generate`, `reveal`, `revoke`, `current`, `versions`. 
* **Teams**: `enrollment-token` (JWT + `qr_svg`). 

---

## Implementation guard-rails for agents

* **Never store PIN plaintext** on device or send to device APIs; only verifiers/params are allowed. Admin plaintext is decrypt-on-reveal on server with AEAD + master key outside DB. 
* **All time decisions** must use the **trusted clock** derived from server epoch + monotonic elapsed time; treat backdating as violation. 
* **Policies must be signature-verified** (Ed25519) before apply; keep last-good on failure. 
* **Zero pre-enrollment**: capture model/OS at provisioning; device table is built **JIT**. 

---

If you want, I can turn this into a one-page “Agent Contract” (OpenAPI + test fixtures list + expected event enums) so your coding agents can start generating endpoints and client adapters immediately.
