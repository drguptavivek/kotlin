Here you go — **updated ADMIN PIN endpoints** (aligned with: server-generated PINs, admins can view plaintext anytime; DB stores verifier + libsodium-encrypted ciphertext).

## Admin PIN API

| Method   | Path                                | Auth      | Purpose                                                                                                                                   |
| -------- | ----------------------------------- | --------- | ----------------------------------------------------------------------------------------------------------------------------------------- |
| **POST** | `/v1/admin/pin/team/generate`       | Admin JWT | Auto-generate **Team PIN** for a team or a single device (creates new version; stores Argon2id verifier + libsodium-encrypted plaintext). |
| **POST** | `/v1/admin/pin/supervisor/generate` | Admin JWT | Auto-generate **Supervisor PIN** for a team (creates new version; same storage model).                                                    |
| **POST** | `/v1/admin/pin/reveal`              | Admin JWT | **Decrypt and return plaintext PIN** for support use (no limits/MFA; plaintext never persisted in DB).                                    |
| **POST** | `/v1/admin/pin/revoke`              | Admin JWT | Revoke one or more **PIN versions** (Team and/or Supervisor) for a team or device (devices will replace on next policy pull).             |
| **GET**  | `/v1/admin/pin/current`             | Admin JWT | Fetch **current TP/SP versions and metadata** (no plaintext) for a team or device — quick support view.                                   |
| **GET**  | `/v1/admin/pin/versions`            | Admin JWT | List **version history** of TP/SP for a team or device (no plaintext), for audit and troubleshooting.                                     |

---

### Request & response details

#### 1) Generate Team PIN

**POST** `/v1/admin/pin/team/generate`

```json
// Request
{ "team_id": "t_123", "reason": "routine_rotation" }
// or
{ "device_id": "d_abc", "reason": "site_specific_rotation" }

// 200 OK
{ "tp_version": 13 }
```

* Server creates random PIN → stores `verifier_argon2id` + `ciphertext` (AEAD XChaCha20-Poly1305 with master key).
* Plaintext **not** returned here (use `/reveal`).

#### 2) Generate Supervisor PIN

**POST** `/v1/admin/pin/supervisor/generate`

```json
{ "team_id": "t_123", "reason": "quarterly_rotation" }

{ "sp_version": 8 }
```

#### 3) Reveal plaintext PIN (admin view)

**POST** `/v1/admin/pin/reveal`

```json
// Request (team-scoped)
{ "team_id": "t_123", "kind": "TP", "version": 13 }
// or device-scoped
{ "device_id": "d_abc", "kind": "TP", "version": 13 }
// or supervisor PIN
{ "team_id": "t_123", "kind": "SP", "version": 8 }

// 200 OK
{ "pin_plaintext": "482917" }
```

* Server decrypts from DB using libsodium master key (held outside DB) and returns plaintext.

#### 4) Revoke PIN versions

**POST** `/v1/admin/pin/revoke`

```json
// team- or device-scoped; any lists may be empty
{
  "team_id": "t_123",
  "tp_versions": [12],
  "sp_versions": [],
  "reason": "compromised_channel"
}

// 200 OK
{ "revoked": { "tp_versions": [12], "sp_versions": [] } }
```

#### 5) Get current PIN metadata (no plaintext)

**GET** `/v1/admin/pin/current?team_id=t_123`
**GET** `/v1/admin/pin/current?device_id=d_abc`

```json
// 200 OK
{
  "scope": { "team_id": "t_123" },
  "tp": { "version": 13 },
  "sp": { "version": 8 }
}
```

#### 6) List PIN version history (no plaintext)

**GET** `/v1/admin/pin/versions?team_id=t_123&kind=TP&limit=20&offset=0`

```json
// 200 OK
{
  "items": [
    { "kind": "TP", "version": 13, "created_at": "2025-10-07T10:05:00Z", "revoked": false },
    { "kind": "TP", "version": 12, "created_at": "2025-09-01T09:00:00Z", "revoked": true }
  ],
  "next_offset": null
}
```

---

### Status codes (all endpoints)

* **200/204** success • **400** bad request • **401/403** auth/perm • **404** not found • **409** conflict (e.g., invalid scope or already revoked) • **500** server.

### Notes

* Devices **never** receive plaintext; they pull **verifiers + versions** via `/v1/policy` and enforce locally.
* Supervisor 12-hour grant behavior remains unchanged (first valid SP use starts session; after expiry, TP invalid locally until resync).
* Crypto: **Argon2id** for verifier; **AEAD XChaCha20-Poly1305** for ciphertext; **32-byte master key** kept outside DB (env/KMS).


---
## DEVICE FACING PIN API

Here’s the **device-facing PIN API** set—lean, implementation-ready, and aligned with your current design (server-generated PINs, devices get only verifiers and versions, 12-hour supervisor session handled on device).


| Method                | Path                       | Auth          | Purpose                                                                                                                                          |
| --------------------- | -------------------------- | ------------- | ------------------------------------------------------------------------------------------------------------------------------------------------ |
| **GET**               | `/v1/policy?device_id=...` | Device bearer | Pull **signed policy** containing current Team PIN (TP) & Supervisor PIN (SP) **verifiers** and versions, plus session settings and time anchor. |
| **POST**              | `/v1/policy/ack`           | Device bearer | Acknowledge that the device **applied** a specific policy (for audit/drift tracking).                                                            |
| **POST**              | `/v1/pin/verify`           | Device bearer | Optional **online PIN confirm** (TP or SP) to re-anchor time or force drift resolution.                                                          |
| **POST**              | `/v1/events/batch`         | Device bearer | Upload **batched telemetry/audit** (pin successes/failures, supervisor session start/expire, time violations).                                   |
| **POST**              | `/v1/heartbeat`            | Device bearer | Lightweight **liveness + drift hint** (tells device to pull policy if versions differ).                                                          |
| *(Optional)* **POST** | `/v1/supervisor/redeem`    | Device bearer | Redeem **Supervisor Grant** (OTP or signed 12-h SSG) if you also support code/QR unlock in addition to SP PIN.                                   |

---

### Schemas (concise)

#### 1) Pull policy

**GET** `/v1/policy?device_id=d_abc`

**200**

```json
{
  "policy_id": "p_2025_10_07_01",
  "server_epoch_ms": 1760000000000,
  "team_id": "t_123",
  "device_id": "d_abc",
  "tp": {
    "version": 13,
    "verifier": "base64-argon2id-hash",
    "params": { "kdf": "argon2id", "salt": "b64", "mem": 65536, "iters": 3, "parallel": 1 }
  },
  "sp": {
    "version": 8,
    "verifier": "base64-argon2id-hash",
    "params": { "kdf": "argon2id", "salt": "b64", "mem": 65536, "iters": 3, "parallel": 1 }
  },
  "supervisor_session_secs": 43200,
  "signed_at": "2025-10-07T12:00:00Z",
  "signature_ed25519": "b64-signature"
}
```

* Device verifies `signature_ed25519` before applying; stores verifiers **encrypted at rest**.

#### 2) Policy ACK (audit)

**POST** `/v1/policy/ack`

```json
{ "device_id": "d_abc", "policy_id": "p_2025_10_07_01", "tp_version": 13, "sp_version": 8 }
```

**204 No Content**

#### 3) Online PIN verify (optional)

**POST** `/v1/pin/verify`

```json
{ "device_id": "d_abc", "type": "TP", "pin": "123456", "client_time_ms": 1760000002345 }
```

**200**

```json
{ "ok": true, "type": "TP", "tp_version": 13, "sp_version": 8, "policy_id": "p_2025_10_07_01" }
```

**Errors**: `409` version drift (pull `/v1/policy`), `423` time violation, `429` rate limit.

#### 4) Events batch

**POST** `/v1/events/batch`

```json
{
  "device_id": "d_abc",
  "events": [
    { "type": "pin_success", "subtype": "TP", "version": 13, "ts": 1760000002400 },
    { "type": "sp_used", "version": 8, "ts": 1760000003000 },
    { "type": "ss_started", "expires_at": 1760043200000, "ts": 1760000003000 },
    { "type": "tp_invalidated_by_ss_expiry", "ts": 1760043201000 },
    { "type": "time_violation_detected", "skew_ms": 420000, "ts": 1760043300000 }
  ]
}
```

**202**

```json
{ "accepted": 5 }
```

#### 5) Heartbeat

**POST** `/v1/heartbeat`

```json
{ "device_id": "d_abc", "policy_id": "p_2025_10_07_01", "tp_version": 13, "sp_version": 8 }
```

**200**

```json
{ "policy_id": "p_2025_10_07_01", "tp_version": 13, "sp_version": 8, "rotate_hint": false }
```

#### 6) *(Optional)* Supervisor grant redeem (OTP/SSG)

Use only if you support code/QR-based supervisor unlock alongside SP PIN.

**POST** `/v1/supervisor/redeem`

```json
{ "device_id": "d_abc", "grant": "otp_or_signed_blob" }
```

**200**

```json
{ "ok": true, "grant_type": "SSG", "session_secs": 43200, "tp_version": 13, "sp_version": 8 }
```

---

### Status codes (all)

* **200/202/204** success • **400** bad request • **401/403** auth/perm • **404** not found
* **409** version drift/conflict • **423** time violation • **429** rate limit • **500** server

---

### Implementation notes (brief)

* Devices never receive plaintext PINs; only **verifiers + versions**.
* First valid **SP** use triggers the **12-hour supervisor session** locally; after expiry, **TP becomes invalid locally** until `/v1/policy` refresh.
* Use `server_epoch_ms` + `elapsedRealtime()` anchor to detect backdating and gate unlocks accordingly.



Here are concise, implementation-ready payload schemas for the **device-facing PIN API**. Types use JSON-Schema-style notation (string, integer, boolean, object, array). Timestamps are **milliseconds since Unix epoch** unless noted.

---
## API  PAYLAODS 
### 1) GET `/v1/policy?device_id=...`

#### Query

```json
{
  "device_id": "string"   // required; stable device identifier
}
```

#### 200 Response

```json
{
  "policy_id": "string",                 // required; immutable snapshot id
  "server_epoch_ms": 1760000000000,      // required; time anchor from server
  "team_id": "string",                   // required
  "device_id": "string",                 // required (echo)
  "tp": {                                // Team PIN verifier bundle (no plaintext)
    "version": 13,                       // required; monotonic int
    "verifier": "string",                // required; base64 of Argon2id hash (encoded form)
    "params": {                          // required; KDF params for offline check
      "kdf": "argon2id",                 // enum: "argon2id"
      "salt": "string",                  // base64, 16–32 bytes
      "mem": 65536,                      // kibibytes
      "iters": 3,                        // >=1
      "parallel": 1                      // >=1
    }
  },
  "sp": {                                // Supervisor PIN verifier bundle
    "version": 8,
    "verifier": "string",
    "params": { "kdf": "argon2id", "salt": "string", "mem": 65536, "iters": 3, "parallel": 1 }
  },
  "supervisor_session_secs": 43200,      // required; typically 12h
  "signed_at": "2025-10-07T12:00:00Z",   // required; RFC3339
  "signature_ed25519": "string"          // required; base64 signature of canonical payload
}
```

**Notes**

* Device **must verify** `signature_ed25519` before applying.
* Verifier blobs are stored **encrypted at rest** on device.

---

### 2) POST `/v1/policy/ack`

#### Request

```json
{
  "device_id": "string",        // required
  "policy_id": "string",        // required
  "tp_version": 13,             // required
  "sp_version": 8               // required
}
```

#### 204 Response

No body.

---

### 3) POST `/v1/pin/verify`  *(optional online confirm)*

##### Request

```json
{
  "device_id": "string",                  // required
  "type": "TP",                           // enum: "TP" | "SP"  (Team PIN / Supervisor PIN)
  "pin": "string",                        // required; plaintext entered by user
  "client_time_ms": 1760000002345         // required; device wall-clock in ms
}
```

##### 200 Response

```json
{
  "ok": true,                             // required
  "type": "TP",                           // echo
  "tp_version": 13,                       // required
  "sp_version": 8,                        // required
  "policy_id": "string"                   // required
}
```

**Errors**

* `409` (version drift → pull `/v1/policy`), `423` (time violation), `429` (rate limit).

---

### 4) POST `/v1/events/batch`

##### Request

```json
{
  "device_id": "string",            // required
  "events": [                       // required; 1–500 events
    {
      "type": "pin_success",        // enum (see below)
      "subtype": "TP",              // optional enum: "TP" | "SP" (when relevant)
      "version": 13,                // optional; PIN version involved
      "ts": 1760000002400,          // required; event time (ms)
      "expires_at": 1760043200000,  // optional; for ss_started
      "skew_ms": 420000,            // optional; for time_violation_detected
      "details": {                  // optional; small, redaction-safe map
        "reason": "string"
      }
    }
  ]
}
```

**`events[].type` enum (recommended minimal set)**

* `pin_success` (use `subtype` and `version`)
* `pin_failure` (add `details.reason`: `mismatch|lockout|rate_limit`)
* `sp_used`
* `ss_started`
* `ss_expired`
* `tp_invalidated_by_ss_expiry`
* `policy_applied`
* `time_violation_detected`

##### 202 Response

```json
{ "accepted": 3 }   // number of events persisted
```

---

### 5) POST `/v1/heartbeat`

#### Request

```json
{
  "device_id": "string",             // required
  "policy_id": "string",             // required; currently applied policy
  "tp_version": 13,                  // required; currently active local
  "sp_version": 8                    // required
}
```

#### 200 Response

```json
{
  "policy_id": "string",             // server's current view for device
  "tp_version": 13,
  "sp_version": 8,
  "rotate_hint": false               // boolean; if true, device should GET /v1/policy soon
}
```

---

### 6) (Optional) POST `/v1/supervisor/redeem`  *(only if you support OTP/SSG)*

#### Request

```json
{
  "device_id": "string",                 // required
  "grant": "string"                      // required; OTP code or signed SSG blob
}
```

#### 200 Response

```json
{
  "ok": true,                            // required
  "grant_type": "SSG",                   // enum: "OTP" | "SSG"
  "session_secs": 43200,                 // required when ok=true
  "tp_version": 13,                      // current versions for device
  "sp_version": 8
}
```

---

### Cross-cutting constraints

* **Auth**: All device requests carry `Authorization: Bearer <device_token>`.
* **IDs**: `device_id`, `team_id`, `policy_id` are opaque strings (no PII).
* **Sizes**: `events` batch ≤ **200 KB** total; single `details` ≤ **1 KB**.
* **Time**: server compares `client_time_ms` against `server_epoch_ms` anchor (backdate detection).
* **Encoding**: binary fields (`verifier`, salts, signatures) are **base64** strings.
* **Forward-compatibility**: allow unknown fields to be ignored by clients (additive changes).

These schemas are ready to lift into OpenAPI or your server validation layer with minimal tweaks.
