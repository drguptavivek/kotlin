You're right — my earlier Mermaid used features some renderers choke on. Here are **strict, parser-friendly** versions (no special shapes, no classes, no slashes, minimal punctuation).

# Level-0 DFD (actors ↔ processes ↔ data stores)

```mermaid
graph LR
  %% External entities
  FT[Field Team]
  SV[Supervisor]
  ADM[Admin or Tech Support]

  %% Device process
  subgraph DEV[SurveyLauncher Device Process]
    UI[Launcher UI]
    TPV[Team PIN Verifier Encrypted]
    SPV[Supervisor PIN Verifier Encrypted]
    SS[Supervisor Session State 12h]
  end

  %% Server processes
  subgraph S[Backend Services]
    POL[Policy API]
    PIN[PIN Service]
    EVT[Events Ingest]
    DASH[Admin Dashboard]
  end

  %% Data stores
  subgraph D[Data Stores]
    PDB[Policy Database]
    PV[PIN Vault Hashed Verifiers]
    DR[Device Registry]
    EL[Event Log Audit]
  end

  %% Flows
  FT -->|Enter Team PIN| UI
  SV -->|Enter Supervisor PIN or Request Code| UI
  ADM -->|Set or Rotate PINs and Policies| DASH

  UI -->|Policy Pull and Reanchor| POL
  UI -->|Online Verify When Available| PIN
  UI -->|Send Batched Events| EVT

  DASH --> POL
  DASH --> PIN

  POL --> PDB
  POL --> DR
  PIN --> PV
  EVT --> EL

  POL -->|Signed Policy plus New Verifiers| UI
  PIN -->|Result or Tokens| UI
  UI --> SS
```

# End-to-end workflow (onboarding → normal → failures → supervisor → resync → invalidation)

```mermaid
graph TD
  A[Device Provisioned as Device Owner and Launcher Set] --> B[First Run]
  B --> C[Pull Policy]
  C --> D[Store Verifiers Encrypted]
  D --> E{Time Integrity OK}
  E -- No --> E2[Block Team PIN and Allow Supervisor or Sync] --> K[Supervisor Path]
  E -- Yes --> F[Lock Screen Ready]

  %% Normal login
  F --> G[Team Enters PIN]
  G --> H{Attempts and Offline TTL OK}
  H -- No --> H1[Backoff or Lockout] --> K
  H -- Yes --> I{Team PIN Matches Active}
  I -- Yes --> J[Unlock and Launch Allowed Apps] --> Z[Operate and Queue Events]
  I -- No --> H1

  %% Supervisor path with 12h grant
  K --> L[Supervisor Enters PIN]
  L --> M{Supervisor PIN Valid}
  M -- No --> H1
  M -- Yes --> N{Supervisor Session Active}
  N -- No --> O[Start Supervisor Session 12h]
  N -- Yes --> P[Continue Within Supervisor Session]
  O --> P
  P --> Q[Unlock and Operate and Queue Supervisor Events]

  %% Team PIN behavior around session
  P --> R{Supervisor Session Expired}
  R -- No --> Z
  R -- Yes --> R1[Mark Team PIN Invalid Locally Until Resync] --> K

  %% Resync and rotation
  Z --> S[Manual or Periodic Resync]
  S --> T[Pull Policy]
  T --> U{New Versions Available}
  U -- No --> V[Keep Current Active Versions] --> Z
  U -- Yes --> W[Install New Verifiers As Active and Mark Old As Stale] --> X{Was Supervisor Session Active}
  X -- Yes --> X1[Session Continues Until Original Expiry] --> Z
  X -- No --> Z

  %% After resync usage
  R1 --> S
  S --> Y[Use New Team PIN or Supervisor PIN As Per Policy] --> Z
```


## Level 1 DFDs
 — here are **Level-1 DFDs** using strict, parser-friendly Mermaid. I’ve expanded the **Policy API**, the **PIN Service**, and the **Events Ingest** so you can see the internal data flows without fancy shapes or syntax.

# Level-1 DFD — Policy API

```mermaid
graph LR
  %% External entities
  DEV[Device]
  ADM[Admin Dashboard]

  %% Processes
  POL[Policy API]
  VM[Version Manager]
  SIG[Signature Service]

  %% Data stores
  PDB[Policy Database]
  DR[Device Registry]
  KS[Server Key Store]

  %% Flows
  DEV -->|Policy pull request with device id| POL
  ADM -->|Create or edit policy and windows| POL

  POL -->|Lookup device and team| DR
  POL -->|Read current policy and versions| PDB
  POL -->|Compute next policy version if needed| VM
  VM --> POL

  POL -->|Request policy signature| SIG
  SIG -->|Read signing key| KS
  SIG -->|Return signed policy blob| POL

  POL -->|Signed policy with verifiers and versions| DEV
  POL -->|Persist updated policy and version| PDB
```

# Level-1 DFD — PIN Service

```mermaid
graph LR
  %% External entities
  DEV[Device]
  ADM[Admin or Tech Support]

  %% Processes
  PIN[PIN Service]
  KDF[Hasher and Verifier]
  VC[Version Controller]
  SPV[Supervisor PIN Manager]

  %% Data stores
  PV[PIN Vault hashed verifiers]
  DR[Device Registry]
  EL[Event Log Audit]

  %% Admin flows
  ADM -->|Set or rotate team pin| PIN
  ADM -->|Set or rotate supervisor pin| SPV

  %% Write paths
  PIN -->|Derive hash and salt| KDF
  KDF -->|Store team pin verifier with version| PV
  SPV -->|Derive hash and salt for supervisor pin| KDF
  KDF -->|Store supervisor pin verifier with version| PV
  PIN -->|Update versions and linkage to device or team| VC
  VC --> DR

  %% Device online verify and pull
  DEV -->|Online verify optional| PIN
  PIN -->|Fetch verifiers by team or device| PV
  PIN -->|Return verification result or new verifiers| DEV

  %% Audit
  PIN -->|Write admin and device actions| EL
  SPV -->|Write supervisor actions| EL
```

# Level-1 DFD — Events Ingest and Telemetry

```mermaid
graph LR
  %% External entities
  DEV[Device]
  DASH[Admin Dashboard]

  %% Processes
  EVT[Events API]
  BUF[Batch Handler]
  AGG[Aggregator Reports]

  %% Data stores
  EL[Event Log Audit]
  DR[Device Registry]

  %% Flows
  DEV -->|Batched events pin success failure session start expire time violation| EVT
  EVT -->|Validate device and schema| DR
  EVT -->|Buffer and persist| BUF
  BUF --> EL

  DASH -->|Query reports and timelines| AGG
  AGG -->|Read events and build summaries| EL
  AGG -->|Return charts and tables| DASH
```

These drop straight into your spec and align with the behaviors we discussed: signed policy delivery, versioned PIN verifiers, supervisor grant handling, and full audit trails.
