# Provisioning Runbook — End-to-End (Clean, Sequential)

## 0) Pre-flight (once per program)

1. **Server ready:** HTTPS, Postgres, time sync (NTP), JWT/Ed25519 keys.
2. **Teams & roles:** States → Teams; assign national admins, state admins, supervisors, team members.
3. **Policy baseline:** Kiosk allow-list (ODK, Browser, Custom App), login windows, min Android version, heartbeat cadence.
4. **Launcher build:** Sign APK (Device Owner–capable), host at a stable HTTPS URL.
5. **Artifacts prepared:**

   * **Android Setup QR** (OS provisioning; installs APK + sets Device Owner).
   * **Team Enrollment QR batches** (short-TTL tokens) for each team.
   * One-page SOPs for Phase A and Phase B.

---

## Phase A — OS-Level Provisioning (install APK + set Device Owner)

### A1) Using Android Setup QR (recommended; no laptop)

**Who:** Staging team (national/state lab)
**When:** On brand-new or factory-reset tablets

1. **Factory reset** the tablet (or receive new unit).
2. Power on → at the “Hi there” screen **tap 6×** to open the built-in QR scanner.
3. **Scan Android Setup QR** (contains APK URL + DO component + optional Wi-Fi).
4. Device **auto-downloads APK**, installs SurveyLauncher, and sets it as **Device Owner (DO)**.
5. Confirm SurveyLauncher is the **HOME** app and **lock-task** is active.

**Acceptance check:** App opens as launcher; settings are restricted; About page shows “Device Owner: true”.

---

### A2) Using ADB (bench/staging line)

**Who:** Staging team with PCs

1. Factory reset → enable provisioning mode.
2. **ADB push & install** SurveyLauncher APK.
3. **ADB set-device-owner** to your DO component.
4. Reboot → verify launcher is DO.

---

### A3) Using Zero-touch / OEM Enrollment (if available)

**Who:** National IT + OEM/distributor

1. Register DO profile (package + component + APK URL) in the portal.
2. Assign profile to IMEIs/serials.
3. On first boot, device **auto-provisions** with SurveyLauncher as DO.

---

## Phase B — App-Level Enrollment (bind device to Team/State)

**Who:** Field team / supervisors
**Prereq:** Phase A complete; device has network

1. **Generate Enrollment QR** for the target **Team** (admin console).
2. On the device, open **SurveyLauncher → Enroll Device → Scan QR**.
3. App **validates token locally** (signature, TTL) and calls **`/v1/provision`** with device facts (model, OS, DO status, Android ID, security patch, etc.).
4. Server:

   * **Redeems** token (one-time), **upserts DEVICE**, attaches **Team/State**.
   * Applies **generic approval rules** (e.g., DO required, min OS).
   * Returns **device_access_token**, **server time anchor**, **policy_version**.
5. App **pulls signed policy**, **applies kiosk rules** (allow-list, log-in window, radios/background-data), and schedules **heartbeat/telemetry**.

**Acceptance check:**
– “Team: <name> / State: <name>” visible in **About/Status**.
– Policy version shown and current.
– **Heartbeat OK** (last-seen < 2 min).
– Whitelisted apps visible only (ODK, Browser, Custom App).

---

## Phase C — First Login & Operational Readiness

1. **Team login:** Enter **Team PIN** (offline verify against policy verifiers).
2. **Supervisor path (if needed):** Use **Supervisor PIN** to start a time-boxed supervisor session.
3. **Connectivity test:** Open ODK, perform a **test form submission**.
4. **Dashboard check (control room):** Device shows **ACTIVE**, correct app/OS versions, and location (if enabled).

**Acceptance check:** PIN works; test submission received; dashboard reflects last-seen and policy version.

---

## Phase D — Handover to Field Use

1. **Seal device:** Apply asset tag; record **device_id** (from app) against physical serial/IMEI.
2. **Issue SOP sheet** (PIN help, enrollment steps, common errors).
3. **Record custodian:** Team + supervisor names and hand-over timestamp.

---

## Exception Paths & Recovery (fast reference)

* **QR expired:** Admin **regenerates Enrollment QR**; device rescan.
* **Provisioning fails DO check:** Re-run **Phase A**; ensure Device Owner is set.
* **Time skew error:** Connect network; the app anchors to **server_epoch** on heartbeat.
* **Wrong team enrolled:** Admin **moves device** to another team; device picks change on next **policy/heartbeat**.
* **Lost/stolen tablet:** Admin **blocks device**; policy fetch enforces lockout.

---

## Operations Cadence (after go-live)

1. **Daily:** Review **devices not seen in >24h**, PIN failure spikes, app/OS drift.
2. **Weekly:** Rotate **Enrollment QR batches**; archive redeemed tokens; export observed **device model report**.
3. **Monthly:** **Policy review** (allow-list, windows), APK update via Setup QR profile (or OTA if available).
4. **As needed:** **Rotate Team/Supervisor PINs**, block/retire devices, transfer devices across teams.

---

## Acceptance Criteria (program level)

* 100% of tablets boot into SurveyLauncher as **Device Owner**.
* 100% team bindings via **Phase B** completed and visible in dashboard.
* <2% Enrollment QR failures (expiry/replay) at field sites.
* <1% devices without heartbeat in first 24 hours after handover.
* All teams complete **test ODK submission** on Day-0.

---

## Deliverables Checklist

* **Android Setup QR** (reusable).
* **Team Enrollment QR batches** (per team; short TTL).
* **SOPs** (Phase A, Phase B, PIN support, error codes).
* **Postman collection** (provision, heartbeat, policy).
* **Dashboard views** (Active devices, Not-seen-24h, PIN failure heatmap, Observed models).

---

## Data Captured at Provisioning (server)

* `device_id`, `team_id`, `state_id`, `android_id`, `manufacturer`, `model`, `hardware`, `os_version`, `security_patch`, `fingerprint`, `is_device_owner`, `app_version`, `first_seen_at`, `approval_state`, `last_seen_at`, `last_policy_version`.

---

### One-page version?

Say the word and I’ll condense this into a printable A4 “Field Provisioning Checklist” with tick boxes for Phase A/B/C and a 10-item troubleshooting box.
